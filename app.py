from flask import Flask, render_template, request, jsonify
import hashlib
from os import mkdir
from subprocess import Popen, PIPE

class App:
    def __init__(self):
        self.app = Flask(__name__)
    
    def routes(self):
        @self.app.route("/")
        def index():
            return render_template('index.html')
        
        @self.app.route('/result', methods = ['GET', 'POST'])
        def upload_file():
            if request.method == 'POST':
                # Get the file
                f = request.files['file']
                global r
                r = f.read()

                signatures = {}
                # Get the MD5 of it
                md5 = hashlib.md5()
                md5.update(r)
                signatures['md5'] = md5.hexdigest()

                # Other signatures
                sha1 = hashlib.sha1()
                sha1.update(r)
                signatures['sha1'] = sha1.hexdigest()

                sha256 = hashlib.sha256()
                sha256.update(r)
                signatures['sha256'] = sha256.hexdigest()
                
                
                # Save the file
                try:
                    mkdir("env/" + md5.hexdigest())
                    with open("env/" + md5.hexdigest() + "/" + f.filename, "wb") as file:
                        file.write(r)
                        file.close()
                        
                except FileExistsError: pass

                # Execute Spigot Anti-Malware
                cmd = Popen("cd env/ && java -jar MCAntiMalware.jar --singleScan true --scanFile " + md5.hexdigest() + "/" + f.filename, shell=True, stdout=PIPE, stderr=PIPE).communicate()[0]
                
                # Handle the results
                result = {"warnings": [], "detections": []}
                for line in str(cmd).split("\\n"):
                    if "[WARNING]" in line: result["warnings"].append(line.split("[WARNING]:")[1])
                    elif "[DETECTED]" in line: result["detections"].append(line.split("[DETECTED]: " + md5.hexdigest() + "/" + f.filename + " MIGHT be infected with ")[1])
                

                return render_template("result.html", result=result, signatures=signatures)
            else: return "Invalid upload request."

if __name__ == '__main__':
    instance = App()
    instance.routes()
    instance.app.run()